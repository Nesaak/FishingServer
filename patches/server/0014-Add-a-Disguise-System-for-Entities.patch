From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Nesaak <52047222+Nesaak@users.noreply.github.com>
Date: Sat, 20 Jun 2020 09:19:56 -0400
Subject: [PATCH] Add a Disguise System for Entities


diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index e0ab058bf947ea10b37eadf6122292e708bd3809..68c34b8752c53853000267cb822418772e8d12a3 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -202,6 +202,18 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
     // Spigot end
     public boolean shouldBeRemoved; // Paper
 
+    // Nesaak start - Disguise System
+    public java.util.function.BiFunction<EntityPlayer, Entity, Packet> disguise;
+    public void refreshEntity() {
+        tracker.trackerEntry.broadcast(new PacketPlayOutEntityDestroy(getId()));
+        for (EntityPlayer trackedPlayer : tracker.trackerEntry.trackedPlayers) {
+            tracker.trackerEntry.a(packet -> {
+                trackedPlayer.playerConnection.sendPacket(packet);
+            }, trackedPlayer);
+        }
+    }
+    // Nesaak end
+
     public float getBukkitYaw() {
         return this.yaw;
     }
diff --git a/src/main/java/net/minecraft/server/EntityTrackerEntry.java b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
index 5cc89c0cf9e9e632212a9653391437cbe9b15031..cc1a5ff6c10c3c23cda0174c0d6d13cc915f8379 100644
--- a/src/main/java/net/minecraft/server/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
@@ -277,7 +277,14 @@ public class EntityTrackerEntry {
             // CraftBukkit end
         }
 
-        Packet<?> packet = this.tracker.L();
+        // Nesaak start
+        Packet<?> packet;
+        if (this.tracker.disguise == null) {
+            packet = this.tracker.L();
+        } else {
+            packet = this.tracker.disguise.apply(entityplayer, this.tracker);
+        }
+        // Nesaak end
 
         this.headYaw = MathHelper.d(this.tracker.getHeadRotation() * 256.0F / 360.0F);
         consumer.accept(packet);
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index d16d3fe58e6a45e3023946174d2e137a0670e455..90688f3c27fe29924d32d2e51b50982bfc34dd66 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -6,137 +6,9 @@ import com.google.common.collect.Lists;
 import java.util.List;
 import java.util.Set;
 import java.util.UUID;
-import net.minecraft.server.AxisAlignedBB;
-import net.minecraft.server.BlockPosition;
-import net.minecraft.server.DamageSource;
-import net.minecraft.server.Entity;
-import net.minecraft.server.EntityAmbient;
-import net.minecraft.server.EntityAnimal;
-import net.minecraft.server.EntityAreaEffectCloud;
-import net.minecraft.server.EntityArmorStand;
-import net.minecraft.server.EntityArrow;
-import net.minecraft.server.EntityBat;
-import net.minecraft.server.EntityBee;
-import net.minecraft.server.EntityBlaze;
-import net.minecraft.server.EntityBoat;
-import net.minecraft.server.EntityCat;
-import net.minecraft.server.EntityCaveSpider;
-import net.minecraft.server.EntityChicken;
-import net.minecraft.server.EntityCod;
-import net.minecraft.server.EntityComplexPart;
-import net.minecraft.server.EntityCow;
-import net.minecraft.server.EntityCreature;
-import net.minecraft.server.EntityCreeper;
-import net.minecraft.server.EntityDolphin;
-import net.minecraft.server.EntityDragonFireball;
-import net.minecraft.server.EntityDrowned;
-import net.minecraft.server.EntityEgg;
-import net.minecraft.server.EntityEnderCrystal;
-import net.minecraft.server.EntityEnderDragon;
-import net.minecraft.server.EntityEnderPearl;
-import net.minecraft.server.EntityEnderSignal;
-import net.minecraft.server.EntityEnderman;
-import net.minecraft.server.EntityEndermite;
-import net.minecraft.server.EntityEvoker;
-import net.minecraft.server.EntityEvokerFangs;
-import net.minecraft.server.EntityExperienceOrb;
-import net.minecraft.server.EntityFallingBlock;
-import net.minecraft.server.EntityFireball;
-import net.minecraft.server.EntityFireworks;
-import net.minecraft.server.EntityFish;
-import net.minecraft.server.EntityFishingHook;
-import net.minecraft.server.EntityFlying;
-import net.minecraft.server.EntityFox;
-import net.minecraft.server.EntityGhast;
-import net.minecraft.server.EntityGiantZombie;
-import net.minecraft.server.EntityGolem;
-import net.minecraft.server.EntityGuardian;
-import net.minecraft.server.EntityGuardianElder;
-import net.minecraft.server.EntityHanging;
-import net.minecraft.server.EntityHorse;
-import net.minecraft.server.EntityHorseAbstract;
-import net.minecraft.server.EntityHorseChestedAbstract;
-import net.minecraft.server.EntityHorseDonkey;
-import net.minecraft.server.EntityHorseMule;
-import net.minecraft.server.EntityHorseSkeleton;
-import net.minecraft.server.EntityHorseZombie;
-import net.minecraft.server.EntityHuman;
-import net.minecraft.server.EntityIllagerAbstract;
-import net.minecraft.server.EntityIllagerIllusioner;
-import net.minecraft.server.EntityIllagerWizard;
-import net.minecraft.server.EntityIronGolem;
-import net.minecraft.server.EntityItem;
-import net.minecraft.server.EntityItemFrame;
-import net.minecraft.server.EntityLargeFireball;
-import net.minecraft.server.EntityLeash;
-import net.minecraft.server.EntityLightning;
-import net.minecraft.server.EntityLiving;
-import net.minecraft.server.EntityLlama;
-import net.minecraft.server.EntityLlamaSpit;
-import net.minecraft.server.EntityLlamaTrader;
-import net.minecraft.server.EntityMagmaCube;
-import net.minecraft.server.EntityMinecartAbstract;
-import net.minecraft.server.EntityMinecartChest;
-import net.minecraft.server.EntityMinecartCommandBlock;
-import net.minecraft.server.EntityMinecartFurnace;
-import net.minecraft.server.EntityMinecartHopper;
-import net.minecraft.server.EntityMinecartMobSpawner;
-import net.minecraft.server.EntityMinecartRideable;
-import net.minecraft.server.EntityMinecartTNT;
-import net.minecraft.server.EntityMonster;
-import net.minecraft.server.EntityMushroomCow;
-import net.minecraft.server.EntityOcelot;
-import net.minecraft.server.EntityPainting;
-import net.minecraft.server.EntityPanda;
-import net.minecraft.server.EntityParrot;
-import net.minecraft.server.EntityPhantom;
-import net.minecraft.server.EntityPig;
-import net.minecraft.server.EntityPigZombie;
-import net.minecraft.server.EntityPillager;
-import net.minecraft.server.EntityPlayer;
-import net.minecraft.server.EntityPolarBear;
-import net.minecraft.server.EntityPotion;
-import net.minecraft.server.EntityProjectile;
-import net.minecraft.server.EntityPufferFish;
-import net.minecraft.server.EntityRabbit;
-import net.minecraft.server.EntityRavager;
-import net.minecraft.server.EntitySalmon;
-import net.minecraft.server.EntitySheep;
-import net.minecraft.server.EntityShulker;
-import net.minecraft.server.EntityShulkerBullet;
-import net.minecraft.server.EntitySilverfish;
-import net.minecraft.server.EntitySkeletonAbstract;
-import net.minecraft.server.EntitySkeletonStray;
-import net.minecraft.server.EntitySkeletonWither;
-import net.minecraft.server.EntitySlime;
-import net.minecraft.server.EntitySmallFireball;
-import net.minecraft.server.EntitySnowball;
-import net.minecraft.server.EntitySnowman;
-import net.minecraft.server.EntitySpectralArrow;
-import net.minecraft.server.EntitySpider;
-import net.minecraft.server.EntitySquid;
-import net.minecraft.server.EntityTNTPrimed;
-import net.minecraft.server.EntityTameableAnimal;
-import net.minecraft.server.EntityThrownExpBottle;
-import net.minecraft.server.EntityThrownTrident;
-import net.minecraft.server.EntityTippedArrow;
-import net.minecraft.server.EntityTropicalFish;
-import net.minecraft.server.EntityTurtle;
-import net.minecraft.server.EntityVex;
-import net.minecraft.server.EntityVillager;
-import net.minecraft.server.EntityVillagerAbstract;
-import net.minecraft.server.EntityVillagerTrader;
-import net.minecraft.server.EntityVindicator;
-import net.minecraft.server.EntityWaterAnimal;
-import net.minecraft.server.EntityWitch;
-import net.minecraft.server.EntityWither;
-import net.minecraft.server.EntityWitherSkull;
-import net.minecraft.server.EntityWolf;
-import net.minecraft.server.EntityZombie;
-import net.minecraft.server.EntityZombieHusk;
-import net.minecraft.server.EntityZombieVillager;
-import net.minecraft.server.IChatBaseComponent;
-import net.minecraft.server.NBTTagCompound;
+import java.util.function.BiFunction;
+
+import net.minecraft.server.*;
 import org.bukkit.Chunk; // Paper
 import org.bukkit.EntityEffect;
 import org.bukkit.Location;
@@ -1058,4 +930,13 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         return getHandle().spawnReason;
     }
     // Paper end
+
+    // Nesaak start - disguises
+    public void setDisguise(BiFunction<EntityPlayer, Entity, Packet> disguise) {
+        getHandle().disguise = disguise;
+        if (isValid()) {
+            getHandle().refreshEntity();
+        }
+    }
+    // Nesaak end
 }
